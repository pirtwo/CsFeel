name: Publish NuGet Package

on:
  workflow_dispatch:

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: üßæ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: üìú List all Git tags
        run: |
          echo "--- ALL TAGS ---"
          git tag --list
          echo ""
          echo "--- RECENT COMMITS ---"
          git log --oneline -n 10 --decorate
          echo ""
          echo "--- MINVER BASE VERSION ---"
          dotnet minver

      - name: üß∞ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: üì¶ Restore dependencies
        run: dotnet restore ./CsFeel/CsFeel.csproj

      - name: üß™ Run tests
        run: dotnet test ./CsFeel.Test/CsFeel.Test.csproj --configuration Release

      - name: üõ†Ô∏è Build CsFeel (uncached)
        run: |
          # Clear any cached version
          dotnet clean ./CsFeel/CsFeel.csproj
          # Build with detailed MinVer output
          dotnet build ./CsFeel/CsFeel.csproj --configuration Release /p:MinVerVerbosity=detailed /p:MinVerSkip=false

      - name: üì¶ Pack with MinVer
        id: pack
        run: |
          # Force fresh version calculation
          dotnet clean ./CsFeel/CsFeel.csproj
          dotnet pack ./CsFeel/CsFeel.csproj \
            --configuration Release \
            --output ./nuget \
            /p:MinVerVerbosity=detailed \
            /p:MinVerSkip=false \
            /p:MinVerBuildMetadata=ci

          # Extract version from package
          PACKAGE_FILE=$(ls ./nuget/*.nupkg | head -1)
          PACKAGE_VERSION=$(basename "$PACKAGE_FILE" | grep -oP '\d+\.\d+\.\d+')

          echo "PACKAGE_VERSION=${PACKAGE_VERSION}" >> $GITHUB_OUTPUT
          echo "TAG_NAME=v${PACKAGE_VERSION}" >> $GITHUB_OUTPUT
          echo "Package version: ${PACKAGE_VERSION}"

      - name: üìù Create GitHub Release
        if: success()
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.pack.outputs.TAG_NAME }}
          name: Release ${{ steps.pack.outputs.TAG_NAME }}
          body: |
            ### Version ${{ steps.pack.outputs.PACKAGE_VERSION }}
            - MinVer-generated from Git history
            - Includes all changes since last release
          draft: false
          prerelease: false
          generate_release_notes: true

      - name: üöÄ Publish to NuGet.org
        run: dotnet nuget push ./nuget/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json
